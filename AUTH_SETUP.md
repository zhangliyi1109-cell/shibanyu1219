# 用户认证系统设置指南

## ✅ 已完成的功能

1. **登录/注册界面**
   - 美观的登录/注册表单
   - 支持邮箱+密码登录
   - 支持新用户注册
   - 忘记密码功能
   - 密码显示/隐藏切换

2. **用户数据隔离**
   - 所有数据按用户ID存储
   - 每个用户只能访问自己的数据
   - 自动使用登录用户的ID

3. **认证状态管理**
   - 自动检测登录状态
   - 会话持久化
   - 自动刷新token

## 🔧 Supabase 配置

### 1. 启用邮箱认证

在 Supabase 控制台中：

1. 进入 **Authentication** → **Providers**
2. 确保 **Email** 提供商已启用
3. 配置邮箱设置：
   - **Enable email confirmations**: 可选（建议开发时关闭，生产环境开启）
   - **Secure email change**: 可选

### 2. 配置邮箱模板（可选）

如果需要自定义邮件模板：

1. 进入 **Authentication** → **Email Templates**
2. 可以自定义：
   - 确认邮件模板
   - 重置密码邮件模板
   - 邀请邮件模板

### 3. 配置重定向URL

1. 进入 **Authentication** → **URL Configuration**
2. 添加重定向URL：
   - Site URL: `http://localhost:3000` (开发环境)
   - Redirect URLs: 
     - `http://localhost:3000/**`
     - `https://your-domain.com/**` (生产环境)

## 📝 使用说明

### 用户注册

1. 打开应用
2. 点击"注册"标签
3. 填写：
   - 邮箱（必填）
   - 密码（至少6位，必填）
   - 姓名（可选）
4. 点击"注册"按钮
5. 如果启用了邮箱验证，需要检查邮箱并点击验证链接

### 用户登录

1. 打开应用
2. 在登录界面填写：
   - 邮箱
   - 密码
3. 点击"登录"按钮

### 忘记密码

1. 在登录界面点击"忘记密码？"
2. 输入邮箱地址
3. 点击"发送重置邮件"
4. 检查邮箱并按照说明重置密码

### 登出

1. 点击右上角的登出按钮（LogOut图标）
2. 确认登出

## 🔒 数据安全

### 用户数据隔离

- 所有数据表都使用 `user_id` 字段
- 每个用户只能访问自己的数据
- 数据查询自动过滤用户ID

### 认证安全

- 使用 Supabase Auth 进行认证
- 密码加密存储
- 支持会话管理
- 自动token刷新

## 🚨 重要提示

### 开发环境

如果启用了邮箱验证，注册后需要：
1. 检查邮箱（包括垃圾邮件）
2. 点击验证链接
3. 然后才能登录

**开发建议**：在开发时可以暂时关闭邮箱验证，方便测试。

### 生产环境

1. **必须启用邮箱验证**
2. 配置正确的重定向URL
3. 设置隐私政策链接
4. 配置邮箱服务（SMTP）

## 🔄 数据迁移

### 现有用户数据

如果之前使用 `user_id = 'default'` 存储数据：

1. 用户注册后，新数据会使用新的用户ID
2. 旧数据仍然保留在数据库中
3. 如果需要迁移旧数据到新用户：
   - 可以在 Supabase SQL Editor 中执行迁移脚本
   - 或创建数据迁移工具

### 迁移脚本示例

```sql
-- 将 default 用户的数据迁移到指定用户
-- 注意：需要替换 'USER_ID_HERE' 为实际用户ID

UPDATE user_settings 
SET user_id = 'USER_ID_HERE' 
WHERE user_id = 'default';

UPDATE daily_goals 
SET user_id = 'USER_ID_HERE' 
WHERE user_id = 'default';

-- 对其他表执行类似操作...
```

## 🐛 故障排除

### 问题：无法登录

**可能原因：**
1. 邮箱未验证（如果启用了验证）
2. 密码错误
3. Supabase 配置错误

**解决方案：**
1. 检查邮箱是否已验证
2. 确认密码正确
3. 检查 Supabase 配置

### 问题：注册后无法登录

**可能原因：**
1. 邮箱验证未完成
2. Supabase Auth 配置问题

**解决方案：**
1. 检查邮箱验证链接
2. 在 Supabase 控制台检查用户状态

### 问题：数据不显示

**可能原因：**
1. 用户ID不匹配
2. 数据查询错误

**解决方案：**
1. 检查浏览器控制台错误
2. 确认用户已正确登录
3. 检查 Supabase 数据表

## 📚 相关文件

- `services/authService.ts` - 认证服务
- `components/Login.tsx` - 登录组件
- `services/supabaseService.ts` - 数据服务（已更新为使用用户ID）
- `App.tsx` - 主应用（已添加认证检查）

## 🎉 完成

现在你的应用已经支持：
- ✅ 用户注册和登录
- ✅ 用户数据隔离
- ✅ 安全的认证系统
- ✅ 会话管理

用户可以注册账号，所有数据都会安全地存储在各自的账号下！

